import se.bjurr.gitchangelog.plugin.gradle.GitChangelogTask
import se.bjurr.gitchangelog.api.InclusivenessStrategy

// Top-level build file where you can add configuration options common to all sub-projects/modules.
plugins {
    alias(libs.plugins.androidApplication) apply false
    alias(libs.plugins.gitChangelog)
}

apply from: 'app/version.gradle'

tasks.register('gitReleaseNotesTask', GitChangelogTask) {
    def tag = getCurrentGitRevision()
    if (tag == "") {
        toRevision = "HEAD"
    } else {
        toRevision = tag
    }
    println "Generating Release notes for " + toRevision
    def prev_tag = getCurrentPrevGitVersion(tag)
    println "Compare to previous " + prev_tag

    fromRevisionStrategy = InclusivenessStrategy.EXCLUSIVE
    fromRevision = prev_tag
    file = new File("${rootDir}/RELEASE_NOTES.md")
    prependToFile = false // false will replace the file, true will prepend content
    templateContent = """{{#tags}}# Release {{name}} ({{tagDate}})

  {{#ifContainsType commits type='feat'}}
## Features

    {{#commits}}
      {{#ifCommitType . type='feat'}}
 - {{#eachCommitScope .}} **{{.}}** {{/eachCommitScope}} {{{commitDescription .}}} ([{{hash}}](https://github.com/ffalt/starfield/commit/{{hashFull}}))
      {{/ifCommitType}}
    {{/commits}}
  {{/ifContainsType}}
  {{#ifContainsType commits type='fix'}}

## Bug Fixes

    {{#commits}}
      {{#ifCommitType . type='fix'}}
 - {{#eachCommitScope .}} **{{.}}** {{/eachCommitScope}} {{{commitDescription .}}} ([{{hash}}](https://github.com/ffalt/starfield/commit/{{hashFull}}))
      {{/ifCommitType}}
    {{/commits}}
  {{/ifContainsType}}

## Full Changelog

https://github.com/ffalt/starfield/compare/PREVIOUS...{{name}}
{{/tags}}
""".replace("PREVIOUS", prev_tag)
}

tasks.register('gitChangelogTask', GitChangelogTask) {
    fromRevision = "440bdfdf94c09ef4edf1885b25852078a66d6332"
    toRevision = "HEAD"
    templateContent = """# Changelog Starfield Live Wallpaper
{{#tags}}

{{#ifEquals name "Unreleased"}}
## Unreleased
{{else}}
## [{{name}}](https://github.com/ffalt/starfield/compare/{{name}}) ({{tagDate .}})
{{/ifEquals}}

  {{#ifContainsType commits type='feat'}}
### Features

    {{#commits}}
      {{#ifCommitType . type='feat'}}
 - {{#eachCommitScope .}} **{{.}}** {{/eachCommitScope}} {{{commitDescription .}}} ([{{hash}}](https://github.com/ffalt/starfield/commit/{{hashFull}}))
      {{/ifCommitType}}
    {{/commits}}
  {{/ifContainsType}}

  {{#ifContainsType commits type='fix'}}
### Bug Fixes

    {{#commits}}
      {{#ifCommitType . type='fix'}}
 - {{#eachCommitScope .}} **{{.}}** {{/eachCommitScope}} {{{commitDescription .}}} ([{{hash}}](https://github.com/ffalt/starfield/commit/{{hashFull}}))
      {{/ifCommitType}}
    {{/commits}}
  {{/ifContainsType}}
{{/tags}}
 """
}

tasks.register('gitShowVersionTask') {
    def info = "\nVERSION INFO:\n\tFull version name: " + getFullVersionName() +
           "\n\tAndroid version name: " + getAndroidVersionName() +
            "\n\tAndroid version code: " + getAndroidVersionCode() +
            "\n\tAndroid Git branch: " + getGitBranch() +
            "\n\tAndroid Git describe: " + getAndroidGitDescribe() +
            "\n\tGit SHA: " + getGitSha() +
            "\n\tBuild Time: " + getBuildTime() +
            "\n\tLatest Git Tag: " + getGitVersion() +
            "\n\tPrevious Git Tag: " + getPrevGitVersion() +
            "\n"
    println(info);
}